name: Github Release

on:
  workflow_run:
    workflows: [".NET Test"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag (e.g. v1.1.0)"
        required: true

permissions:
  contents: write

jobs:
  release:
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' && startsWith(github.event.workflow_run.head_branch, 'v'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore dependencies
        run: dotnet restore NuGone.slnx

      - name: Build
        run: dotnet build NuGone.slnx --no-restore --configuration Release

      - name: Pack NuGet package
        run: dotnet pack src/presentation/NuGone.Cli/NuGone.Cli.csproj --no-build --configuration Release --output ./nupkg

      - name: Publish CLI for multiple frameworks
        run: |
          # Publish for each framework
          dotnet publish src/presentation/NuGone.Cli/NuGone.Cli.csproj \
            --configuration Release \
            --framework net8.0 \
            --output ./publish/net8.0 \
            --no-build

          dotnet publish src/presentation/NuGone.Cli/NuGone.Cli.csproj \
            --configuration Release \
            --framework net9.0 \
            --output ./publish/net9.0 \
            --no-build

          dotnet publish src/presentation/NuGone.Cli/NuGone.Cli.csproj \
            --configuration Release \
            --framework net10.0 \
            --output ./publish/net10.0 \
            --no-build

      - name: Archive published CLI for multiple frameworks
        run: |
          # Create separate archives for each framework
          tar -czf ./nugone-cli-net8.0.tar.gz -C ./publish/net8.0 .
          tar -czf ./nugone-cli-net9.0.tar.gz -C ./publish/net9.0 .
          tar -czf ./nugone-cli-net10.0.tar.gz -C ./publish/net10.0 .

          # Create a combined archive with all frameworks
          mkdir -p ./nugone-cli-all
          cp -r ./publish/net8.0/* ./nugone-cli-all/
          cp -r ./publish/net9.0/* ./nugone-cli-all/
          cp -r ./publish/net10.0/* ./nugone-cli-all/
          tar -czf ./nugone-cli-all.tar.gz -C ./nugone-cli-all .

      - name: Get tag name
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            # For workflow_run triggered by tag pushes, use head_branch which contains the tag name
            echo "tag=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Validate tag format
        run: |
          tag="${{ steps.get_tag.outputs.tag }}"
          if ! echo "$tag" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Invalid tag format: $tag. Expected format: v1.2.3"
            exit 1
          fi
          echo "Tag format validated: $tag"

      - name: Validate build artifacts
        run: |
          if [ ! -d "./nupkg" ] || [ -z "$(ls -A ./nupkg/*.nupkg 2>/dev/null)" ]; then
            echo "No NuGet packages found in ./nupkg directory"
            exit 1
          fi

          # Check for all CLI archives
          archives=("nugone-cli-net8.0.tar.gz" "nugone-cli-net9.0.tar.gz" "nugone-cli-net10.0.tar.gz" "nugone-cli-all.tar.gz")
          for archive in "${archives[@]}"; do
            if [ ! -f "./$archive" ]; then
              echo "CLI archive $archive not found"
              exit 1
            fi
          done

          echo "Build artifacts validated successfully"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: Release ${{ steps.get_tag.outputs.tag }}
          body: |
            Automatically published release.

            For detailed changes, see the [CHANGELOG.md for this release](https://github.com/ahmet-cetinkaya/nugone/blob/${{ steps.get_tag.outputs.tag }}/CHANGELOG.md).
          files: |
            ./nupkg/*.nupkg
            ./nugone-cli-net8.0.tar.gz
            ./nugone-cli-net9.0.tar.gz
            ./nugone-cli-net10.0.tar.gz
            ./nugone-cli-all.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-nuget:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Get tag name
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            # For workflow_run triggered by tag pushes, use head_branch which contains the tag name
            echo "tag=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Download release assets
        run: |
          mkdir -p ./nupkg
          gh release download ${{ steps.get_tag.outputs.tag }} --repo ${{ github.repository }} --pattern '*.nupkg' --dir ./nupkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to NuGet
        run: |
          nupkg_file=$(ls ./nupkg/*.nupkg | head -n1)
          if [ -z "$nupkg_file" ]; then
            echo "No nupkg file found. Failing workflow."
            exit 1
          fi
          echo "Publishing $nupkg_file to NuGet..."
          dotnet nuget push "$nupkg_file" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
